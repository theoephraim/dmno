{"version":3,"sources":["../../src/build-plugin/index.ts"],"names":[],"mappings":";;;;AAEA,SAAS,gBAAgB;AACzB,OAAO,QAAQ;AAaf,IAAM,UAAU,SAAS,2CAA2C,EAAE,SAAS;AAK/E,IAAM,sBAAsB;AAAA;AAAA,4DAEgC,OAAO;AAAA;AAGnE,eAAsB,QAAQ,MAAW;AACvC,UAAQ,IAAI,eAAe;AAC3B,QAAM,oBAAoB,KAAK,UAAU,WAAW,KAAK,MAAM,MAAM,YAAY,EAAE,QAAQ,YAAY,EAAE,IAAI;AAE7G,uBAAqB,iBAAiB;AAGtC,QAAM,eAAe,MAAM,KAAK,MAAM,UAAU,KAAK;AACrD,UAAQ,IAAI,YAAY;AACxB,aAAW,MAAM,cAAc;AAC7B,UAAM,cAAc,MAAM,GAAG,SAAS,SAAS,GAAG,UAAU,MAAM;AAKlE,UAAM,aAAa;AAAA,IAA4C;AAC/D,UAAM,GAAG,SAAS,UAAU,GAAG,UAAU,YAAY,MAAM;AAC3D,YAAQ,IAAI,wBAAsB,GAAG,UAAU,YAAY,OAAO,GAAE,GAAG,CAAC;AAAA,EAC1E;AAGA,QAAM,aAAa,GAAG,iBAAiB;AACvC,QAAM,kBAAkB,MAAM,GAAG,SAAS,QAAQ,YAAY,EAAE,WAAW,KAAK,CAAC;AACjF,aAAW,kBAAkB,iBAAiB;AAC5C,QAAI,EAAE,eAAe,SAAS,MAAM,KAAK,eAAe,SAAS,MAAM,KAAK,eAAe,SAAS,KAAK;AAAI;AAC7G,UAAM,eAAe,GAAG,UAAU,IAAI,cAAc;AACpD,UAAM,cAAc,MAAM,GAAG,SAAS,SAAS,cAAc,MAAM;AAGnE,UAAM,aAAa;AAAA,IAA4C;AAC/D,UAAM,GAAG,SAAS,UAAU,cAAc,YAAY,MAAM;AAC5D,YAAQ,IAAI,6BAA2B,cAAc,YAAY,OAAO,GAAE,GAAG,CAAC;AAAA,EAChF;AACF;AAjCsB;AAmCtB,SAAS,qBAAqB,mBAA2B;AACvD,KAAG,cAAc,GAAG,iBAAiB,0BAA0B,qBAAqB,MAAM;AAC5F;AAFS;AAKF,SAAS,aAAa;AAC3B,UAAQ,IAAI,aAAa;AAC3B;AAFgB;AAIhB,SAAS,qBAAqB,WAAgB;AAC5C,SAAO,UAAU,MAAM,MAAM,YAAY,EAAE,QAAQ,YAAY,EAAE;AACnE;AAFS;AAIF,SAAS,SAAS,MAAW;AAClC,QAAM,EAAE,cAAc,IAAI;AAI1B,UAAQ,IAAI,YAAY;AAAA,IACtB,mCAAmC;AAAA,MACjC,aAAa,cAAc,MAAM,YAAY;AAAA,MAC7C,WAAW,cAAc,MAAM,YAAY;AAAA,MAC3C,QAAQ,cAAc,MAAM,YAAY;AAAA,IAC1C;AAAA,IACA,eAAe;AAAA,MACb,aAAa,QAAQ,IAAI;AAAA,MACzB,WAAW,QAAQ,IAAI;AAAA,MACvB,QAAQ,QAAQ,IAAI;AAAA,IACtB;AAAA,EACF,CAAC;AAGD,QAAM,oBAAoB,qBAAqB,IAAI;AACnD,uBAAqB,iBAAiB;AACxC;AArBgB;AAuBhB,eAAsB,MAAM,MAAW;AAkBvC;AAlBsB","sourcesContent":["// build plugin\n\nimport { execSync } from 'node:child_process';\nimport fs from 'node:fs';\n\n//onPreBuild - runs before the build command is executed.\n//onBuild - runs directly after the build command is executed and before Functions bundling.\n//onPostBuild - runs after the build command completes; after onBuild tasks and Functions bundling are executed; and before the deploy stage. This is when file-based uploads for Netlify Blobs occur. Can be used to prevent a build from being deployed.\n//onError - runs when an error occurs in the build or deploy stage, failing the build. Can’t be used to prevent a build from being deployed.\n//onSuccess - runs when the deploy succeeds. Can’t be used to prevent a build from being deployed.\n//onEnd - runs after completion of the deploy stage, regardless of build error or success; is useful for resources cleanup. Can’t be used to prevent a build from being deployed.\n\n//onPreDev - runs before onDev.\n//onDev - runs directly before the dev command.\n\n\nconst dmnoEnv = execSync('npm exec -- dmno resolve -f json-injected').toString();\n// injectDmnoGlobals({\n//   injectedConfig: JSON.parse(dmnoEnv),\n// });\n\nconst INJECT_DMNO_ENV_SRC = `\nglobalThis.process = globalThis.process || { env: {} };\nglobalThis.process.env.DMNO_INJECTED_ENV = JSON.stringify(${dmnoEnv});\n`\n\nexport async function onBuild(args: any) {\n  console.log('onBuild hook!');\n  const netlifyFolderPath = args.constants.IS_LOCAL ? args.utils.cache.getCacheDir().replace(/\\/[^/]+$/, '') : '/opt/build/repo/.netlify';\n  \n  updateDmnoInjectFile(netlifyFolderPath);\n\n  // handle regular \"functions\" (lambdas)\n  const allFunctions = await args.utils.functions.list();\n  console.log(allFunctions);\n  for (const fn of allFunctions) {\n    const originalSrc = await fs.promises.readFile(fn.mainFile, 'utf8');\n\n    // NOTE - if we inject the config directly, other imports get hoisted above it\n    // so we have to inject an import that includes the config instead\n    // TODO: resolve correct path\n    const updatedSrc = `import '../../inject-dmno-config.js';\\n` + originalSrc;\n    await fs.promises.writeFile(fn.mainFile, updatedSrc, 'utf8');\n    console.log('updated function @ '+fn.mainFile, originalSrc.substr(0,100));\n  }\n\n  // handle \"edge functions\"\n  const edgeFnsDir = `${netlifyFolderPath}/edge-functions`;\n  const edgeFnFileNames = await fs.promises.readdir(edgeFnsDir, { recursive: true });\n  for (const edgeFnFileName of edgeFnFileNames) {\n    if (!(edgeFnFileName.endsWith('.mjs') || edgeFnFileName.endsWith('.cjs') || edgeFnFileName.endsWith('.js'))) continue;\n    const fullFilePath = `${edgeFnsDir}/${edgeFnFileName}`;\n    const originalSrc = await fs.promises.readFile(fullFilePath, 'utf8');\n    // TODO: resolve correct path\n    // see same note above about import vs directly injecting\n    const updatedSrc = `import '../../inject-dmno-config.js';\\n` + originalSrc;\n    await fs.promises.writeFile(fullFilePath, updatedSrc, 'utf8');\n    console.log('updated EDGE function @ '+fullFilePath, originalSrc.substr(0,100));    \n  }\n}\n\nfunction updateDmnoInjectFile(netlifyFolderPath: string) {\n  fs.writeFileSync(`${netlifyFolderPath}/inject-dmno-config.js`, INJECT_DMNO_ENV_SRC, 'utf8');\n}\n\n\nexport function onPreBuild() {\n  console.log('onPreBuild!');\n}\n\nfunction getNetlifyFolderPath(eventArgs: any) {\n  return eventArgs.utils.cache.getCacheDir().replace(/\\/[^/]+$/, '');\n}\n\nexport function onPreDev(args: any) {\n  const { netlifyConfig } = args;\n  \n  // console.log(netlifyConfig);\n  // console.log(utils);\n  console.log('PRE DEV!', {\n    'netlifyConfig.build.environment': {\n      CONTEXT_FOO: netlifyConfig.build.environment.CONTEXT_FOO,\n      BUILD_FOO: netlifyConfig.build.environment.BUILD_FOO,\n      UI_FOO: netlifyConfig.build.environment.UI_FOO,\n    },\n    'process.env': {\n      CONTEXT_FOO: process.env.CONTEXT_FOO,\n      BUILD_FOO: process.env.BUILD_FOO,\n      UI_FOO: process.env.UI_FOO,\n    }\n  });\n\n\n  const netlifyFolderPath = getNetlifyFolderPath(args);\n  updateDmnoInjectFile(netlifyFolderPath);\n}\n\nexport async function onDev(args: any) {\n\n  // console.log('watching file', `${netlifyFolderPath}/edge-functions-serve/dev.js`);\n  // watcher = fs.watch(`${netlifyFolderPath}`, { persistent: false, recursive: true }, () => {\n  //   console.log('file change!');\n  // })\n\n\n  // const blobStore = await getDeployStore();\n  // await blobStore.setJSON('INJECTED_DMNO_ENV', {\n  //   CONTEXT_FOO: process.env.CONTEXT_FOO,\n  //   BUILD_FOO: process.env.BUILD_FOO,\n  //   UI_FOO: process.env.UI_FOO,\n  // });\n\n  // process.DMNO_TEST = 'foo';\n\n  \n}\n\n\n// TRIGGER RESTART BY\n// save netlify.toml? save each fn?\n\n\n// export const onPreBuild = function({\n//   constants,\n//   inputs,\n//   netlifyConfig,\n//   packageJson,\n\n// }) {\n\n//   // process.env - includes all Netlify build environment variables and any variables you declare using the Netlify UI or TOML. We recommend you use this when you only need to get values during the build process.\n//   // netlifyConfig.build.environment - includes only the variables you declare using the Netlify UI or TOML. We recommend you use this when you need to modify values during the build process.\n\n//   console.log(netlifyConfig.build.environment)\n\n//   console.log(\"Hello world from onPreBuild event!\");\n// }\n"]}